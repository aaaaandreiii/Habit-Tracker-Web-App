generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum GoalType {
  LOSS
  MAINTAIN
  GAIN
}

enum HabitType {
  BOOLEAN
  QUANTITY
  DURATION
}

enum FrequencyType {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

enum HabitStatus {
  COMPLETED
  PARTIAL
  MISSED
}

enum GoalScope {
  SHORT_TERM
  LONG_TERM
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum Unit {
  G
  OZ
  ML
  CUP
  PIECE
  SLICE
}

enum ExerciseSource {
  MANUAL
  APPLE_HEALTH
  GOOGLE_FIT
  FITBIT
  GARMIN
  OTHER
}

enum HabitTimeOfDay {
  ANY
  DAY
  NIGHT
}


// MODELS

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  passwordHash  String
  name          String
  age           Int?
  heightCm      Float?
  weightKg      Float?
  gender        Gender?
  activityLevel ActivityLevel? @default(SEDENTARY)
  goalType      GoalType?      @default(MAINTAIN)
  calorieGoal   Int? // user override
  proteinGoalG  Float?
  carbsGoalG    Float?
  fatGoalG      Float?
  waterGoalMl   Int?           @default(2000)
  unitsMetric   Boolean        @default(true)

  habits          Habit[]
  habitGoals      HabitGoal[]
  journalEntries  JournalEntry[]
  userFoodEntries UserFoodEntry[]
  customFoods     CustomFood[]
  recipes         Recipe[]
  waterLogs       WaterLog[]
  exerciseLogs    ExerciseLog[]
  weightLogs      WeightLog[]
  meals           Meal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Habit {
  id             Int           @id @default(autoincrement())
  user           User          @relation(fields: [userId], references: [id])
  userId         Int
  name           String
  description    String?
  habitType      HabitType
  frequencyType  FrequencyType

  daysOfWeek   String?  // e.g. "MON,TUE,FRI" for weekly
  dayOfMonth   Int?     // for monthly (1-31)
  yearlyMonth  Int?     // for yearly (1-12)
  yearlyDay    Int?     // for yearly (1-31)

  scheduleDates HabitScheduleDate[]

  targetValue    Float?
  timesPerPeriod Int?
  startDate      DateTime
  endDate        DateTime?
  category       String?
  color          String?
  icon           String?
  isArchived     Boolean       @default(false)
  streakGrace    Int?          @default(0)

  // NEW
  sortOrder      Int           @default(0)
  timeOfDay      HabitTimeOfDay @default(ANY)

  logs         HabitLog[]
  goals        HabitGoal[]
  journalLinks JournalEntryHabit[]
  HabitGoalItem HabitGoalItem[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([userId, isArchived])
  @@index([userId, sortOrder])
}

model HabitLog {
  id        Int         @id @default(autoincrement())
  habit     Habit       @relation(fields: [habitId], references: [id])
  habitId   Int
  date      DateTime
  status    HabitStatus
  value     Float?
  notes     String?
  createdAt DateTime    @default(now())

  @@index([habitId, date])
}

model HabitGoal {
  id              Int       @id @default(autoincrement())
  userId          Int
  habitId         Int?
  goalScope       GoalScope
  startDate       DateTime
  endDate         DateTime
  target          Int // e.g. number of completions
  description     String?
  currentProgress Int       @default(0)
  createdAt       DateTime  @default(now())

  user  User   @relation(fields: [userId], references: [id])
  habit Habit? @relation(fields: [habitId], references: [id])

  items HabitGoalItem[]

  @@index([userId])
  @@index([habitId])
}

model HabitScheduleDate {
  id      Int      @id @default(autoincrement())
  habitId Int
  date    DateTime

  habit Habit @relation(fields: [habitId], references: [id])

  @@index([habitId, date])
}

model JournalEntry {
  id      Int      @id @default(autoincrement())
  user    User     @relation(fields: [userId], references: [id])
  userId  Int
  date    DateTime
  title   String
  content String
  tags    String? // comma-separated tags

  habitLinks JournalEntryHabit[]

  createdAt DateTime @default(now())

  @@index([userId, date])
}

model JournalEntryHabit {
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  journalEntryId Int

  habit   Habit @relation(fields: [habitId], references: [id])
  habitId Int

  @@id([journalEntryId, habitId])
}

// FOOD DATABASE

model FoodItem {
  id               Int     @id @default(autoincrement())
  name             String
  category         String?
  baseServingSizeG Float   @default(100)
  calories         Float
  protein          Float   @default(0)
  carbs            Float   @default(0)
  fat              Float   @default(0)
  fiber            Float   @default(0)
  sugar            Float   @default(0)
  sodium           Float   @default(0)
  vitaminC         Float   @default(0)
  iron             Float   @default(0)
  isVerified       Boolean @default(false)
  source           String? // e.g. USDA, Manual

  userEntries       UserFoodEntry[]
  recipeIngredients RecipeIngredient[]
  mealItems         MealItem[] // <-- add this

  @@index([name])
  @@index([category])
}

model BrandedFoodItem {
  id           Int     @id @default(autoincrement())
  brandName    String
  productName  String
  barcode      String  @unique
  servingSizeG Float   @default(100)
  calories     Float
  protein      Float   @default(0)
  carbs        Float   @default(0)
  fat          Float   @default(0)
  fiber        Float   @default(0)
  sugar        Float   @default(0)
  sodium       Float   @default(0)
  isVerified   Boolean @default(false)
  source       String?

  userEntries       UserFoodEntry[]
  recipeIngredients RecipeIngredient[]
  mealItems         MealItem[] // <-- add this

  @@index([brandName])
  @@index([productName])
}

model CustomFood {
  id                    Int     @id @default(autoincrement())
  user                  User    @relation(fields: [userId], references: [id])
  userId                Int
  name                  String
  servingSizeDesc       String?
  baseServingSizeAmount Float   @default(100)
  baseServingSizeUnit   Unit    @default(G)
  calories              Float
  protein               Float   @default(0)
  carbs                 Float   @default(0)
  fat                   Float   @default(0)
  fiber                 Float   @default(0)
  sugar                 Float   @default(0)
  sodium                Float   @default(0)

  userEntries       UserFoodEntry[]
  recipeIngredients RecipeIngredient[]
  mealItems         MealItem[] // <-- add this

  @@index([userId])
}

model Recipe {
  id               Int     @id @default(autoincrement())
  user             User    @relation(fields: [userId], references: [id])
  userId           Int
  name             String
  description      String?
  instructions     String?
  numberOfServings Int     @default(1)
  caloriesPerServ  Float   @default(0)
  proteinPerServ   Float   @default(0)
  carbsPerServ     Float   @default(0)
  fatPerServ       Float   @default(0)

  ingredients RecipeIngredient[]
  userEntries UserFoodEntry[]
  mealItems   MealItem[] // <-- add this

  createdAt DateTime @default(now())

  @@index([userId])
}

model RecipeIngredient {
  id       Int    @id @default(autoincrement())
  recipe   Recipe @relation(fields: [recipeId], references: [id])
  recipeId Int

  foodItem          FoodItem?        @relation(fields: [foodItemId], references: [id])
  foodItemId        Int?
  brandedFoodItem   BrandedFoodItem? @relation(fields: [brandedFoodItemId], references: [id])
  brandedFoodItemId Int?
  customFood        CustomFood?      @relation(fields: [customFoodId], references: [id])
  customFoodId      Int?

  quantity Float
  unit     Unit

  @@index([recipeId])
}

// USER FOOD ENTRIES

model UserFoodEntry {
  id       Int      @id @default(autoincrement())
  user     User     @relation(fields: [userId], references: [id])
  userId   Int
  dateTime DateTime
  mealType MealType

  foodItem          FoodItem?        @relation(fields: [foodItemId], references: [id])
  foodItemId        Int?
  brandedFoodItem   BrandedFoodItem? @relation(fields: [brandedFoodItemId], references: [id])
  brandedFoodItemId Int?
  customFood        CustomFood?      @relation(fields: [customFoodId], references: [id])
  customFoodId      Int?
  recipe            Recipe?          @relation(fields: [recipeId], references: [id])
  recipeId          Int?

  quantity Float
  unit     Unit

  calories Float @default(0)
  protein  Float @default(0)
  carbs    Float @default(0)
  fat      Float @default(0)
  fiber    Float @default(0)
  sugar    Float @default(0)
  sodium   Float @default(0)

  createdAt DateTime @default(now())

  @@index([userId, dateTime])
}

// SAVED MEALS

model Meal {
  id          Int     @id @default(autoincrement())
  user        User    @relation(fields: [userId], references: [id])
  userId      Int
  name        String
  description String?

  items MealItem[]

  createdAt DateTime @default(now())
}

model MealItem {
  id     Int  @id @default(autoincrement())
  meal   Meal @relation(fields: [mealId], references: [id])
  mealId Int

  foodItem          FoodItem?        @relation(fields: [foodItemId], references: [id])
  foodItemId        Int?
  brandedFoodItem   BrandedFoodItem? @relation(fields: [brandedFoodItemId], references: [id])
  brandedFoodItemId Int?
  customFood        CustomFood?      @relation(fields: [customFoodId], references: [id])
  customFoodId      Int?
  recipe            Recipe?          @relation(fields: [recipeId], references: [id])
  recipeId          Int?

  quantity Float
  unit     Unit
}

// WATER / EXERCISE / WEIGHT

model WaterLog {
  id       Int      @id @default(autoincrement())
  user     User     @relation(fields: [userId], references: [id])
  userId   Int
  dateTime DateTime
  amount   Float
  unit     Unit     @default(ML)

  createdAt DateTime @default(now())

  @@index([userId, dateTime])
}

model ExerciseLog {
  id             Int            @id @default(autoincrement())
  user           User           @relation(fields: [userId], references: [id])
  userId         Int
  dateTime       DateTime
  exerciseType   String
  durationMin    Int
  caloriesBurned Float
  source         ExerciseSource @default(MANUAL)

  createdAt DateTime @default(now())

  @@index([userId, dateTime])
}

model WeightLog {
  id       Int      @id @default(autoincrement())
  user     User     @relation(fields: [userId], references: [id])
  userId   Int
  date     DateTime
  weightKg Float

  createdAt DateTime @default(now())

  @@index([userId, date])
}

model HabitGoalItem {
  id          Int   @id @default(autoincrement())
  habitGoalId Int
  habitId     Int
  targetCount Int
  weight      Float @default(1)

  goal  HabitGoal @relation(fields: [habitGoalId], references: [id])
  habit Habit     @relation(fields: [habitId], references: [id])

  @@index([habitGoalId])
  @@index([habitId])
}
